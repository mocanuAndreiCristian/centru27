const classData = {
    "3A": {
        timetable: [
            [
                "8:00",
                "Română <img src='img/ro.png' alt='RO' class='text-img' />",
                "Română <img src='img/ro.png' alt='RO' class='text-img' />",
                "Engleză <img src='img/en.png' alt='EN' class='text-img' />",
                "Sport ⚽",
                "Română <img src='img/ro.png' alt='RO' class='text-img' />",
            ],
            [
                "9:00",
                "Mate 📐",
                "Mate 📐",
                "Religie ☦️",
                "Română <img src='img/ro.png' alt='RO' class='text-img' />",
                "Engleză <img src='img/en.png' alt='EN' class='text-img' />",
            ],
            [
                "10:00",
                "Sport ⚽",
                "Civică 🪪",
                "Română <img src='img/ro.png' alt='RO' class='text-img' />",
                "Mate 📐",
                "Mate 📐",
            ],
            ["11:00", "AVAP 🎨", "Mișcare 🕺", "Științe 🥀", "AVAP 🎨", "Muzică 🎹"],
        ],
        manuals: [
            {
                title: "AVAP",
                img: "img/avap3.jpg",
                link: "https://manuale.edu.ro/manuale/Clasa%20a%20III-a/Arte%20vizuale%20si%20abilitati%20practice/Uy5DLiBBUlMgTElCUkkg/",
            },
            {
                title: "Civică",
                img: "img/civica3.jpg",
                link: "https://manuale.edu.ro/manuale/Clasa%20a%20III-a/Educatie%20Civica/Uy5DLiBBUlMgTElCUkkg/",
            },
            {
                title: "Engleză",
                img: "img/engleza3.jpeg",
                link: "https://manuale.edu.ro/manuale/Clasa%20a%20III-a/Limba%20moderna%20engleza/Uy5DLiBVTklTQ0FOIEdS/",
            },
            {
                title: "Mate",
                img: "img/mate3.jpg",
                link: "https://manuale.edu.ro/manuale/Clasa%20a%20III-a/Matematica/Uy5DLiBBUlQgS0xFVFQg/#book/00",
            },
            {
                title: "Muzică",
                img: "img/muzica3.png",
                link: "https://manuale.edu.ro/manuale/Clasa%20a%20III-a/Muzica%20si%20miscare/Uy5DLiBJTlRVSVRFWFQg/",
            },
            {
                title: "Religie",
                img: "img/religie3.jpg",
                link: "https://manuale.edu.ro/manuale/Clasa%20a%20III-a/Religie%20Cultul%20Ortodox/Uy5DLiBBS0FERU1PUyBB/",
            },
            {
                title: "Română",
                img: "img/romana3.jpg",
                link: "https://manuale.edu.ro/manuale/Clasa%20a%20III-a/Limba%20si%20literatura%20romana/Uy5DLiBBUlMgTElCUkkg/",
            },
            {
                title: "Științe",
                img: "img/stiinte3.jpeg",
                link: "https://manuale.edu.ro/manuale/Clasa%20a%20III-a/Stiinte%20ale%20naturii/Uy5DLiBBUlQgS0xFVFQg/",
            },
        ],
    },
    "7D": {
        timetable: [
            ["12:00", "Informatică 💻", "", "Religie ☦️", "", "Mate 📐"],
            ["13:00", "Geografie 🌍", "Chimie 🧪", "Muzică 🎹", "Civică 🪪", "Sport ⚽"],
            [
                "14:00",
                "Mate 📐",
                "Mate 📐",
                "Biologie ⚕️",
                "Chimie 🧪",
                "Engleză <img src='img/en.png' alt='EN' class='text-img' />",
            ],
            [
                "15:00",
                "Română <img src='img/ro.png' alt='RO' class='text-img' />",
                "Franceză <img src='img/fr.png' alt='FR' class='text-img' />",
                "Engleză <img src='img/en.png' alt='EN' class='text-img' />",
                "Fizică ☄️",
                "Franceză <img src='img/fr.png' alt='FR' class='text-img' />",
            ],
            ["16:00", "Biologie ⚕️", "Opț Mate 📐", "Tehnologică 🧰", "Mate 📐", "Latină 🦖"],
            [
                "17:00",
                "Dirigenție 📰",
                "Română <img src='img/ro.png' alt='RO' class='text-img' />",
                "Arte Plastice 🎨",
                "Română <img src='img/ro.png' alt='RO' class='text-img' />",
                "Română <img src='img/ro.png' alt='RO' class='text-img' />",
            ],
            ["18:00", "Istorie 📜", "Fizică ☄️", "", "Sport ⚽", ""],
        ],
        manuals: [
            {
                title: "Biologie",
                img: "img/manual-bio-old.png",
                link: "https://edu.litera.ro/manuale/biologie-7/index.html",
            },
            {
                title: "Chimie",
                img: "img/manual-chimie.jpg",
                link: "https://manuale.edu.ro/manuale/Clasa%20a%20VII-a/Chimie/QVJUIEtMRVRU/#book/00",
            },
            {
                title: "Civică",
                img: "img/manual-civica.png",
                link: "https://manuale.edu.ro/manuale/Clasa%20a%20VII-a/Educatie%20sociala/RURJVFVSQSBTSUdNQQ/#/page/c1",
            },
            {
                title: "Engleză",
                img: "img/manual-engleza.jpg",
                link: "https://catalog.manualedigitaleart.ro/art-engleza-lm1-7-2024/v1/index.html#book/00",
            },
            {
                title: "Fizică",
                img: "img/manual-fizica.jpg",
                link: "https://manuale.edu.ro/manuale/Clasa%20a%20VII-a/Fizica/QVJUIEtMRVRU/#book/00",
            },
            {
                title: "Franceză",
                img: "img/manual-franceza.png",
                link: "https://m.bookl.et/content/fra-vii/index.html#p=-1",
            },
            {
                title: "Geografie",
                img: "img/manual-geo.jpg",
                link: "https://manuale.edu.ro/manuale/Clasa%20a%20VII-a/Geografie/Q0QgUHJlc3M/index.html",
            },
            {
                title: "Informatică",
                img: "img/manual-info.png",
                link: "https://manuale.edu.ro/manuale/Clasa%20a%20VII-a/Informatica%20si%20TIC/R1JVUCBFRElUT1JJQUwg/",
            },
            {
                title: "Istorie",
                img: "img/manual-istorie.jpg",
                link: "https://manuale.edu.ro/manuale/Clasa%20a%20VII-a/Istorie/QWthZGVtb3MgQXJ0/",
            },
            {
                title: "Latină",
                img: "img/manual-latina.jpg",
                link: "https://manuale.edu.ro/manuale/Clasa%20a%20VII-a/Elemente%20de%20limba%20latina%20si%20de%20cultura%20romanica%20/QVJUIEtMRVRU/#book/00",
            },
            { title: "Mate", img: "img/asq.jpg", link: "https://app.asq.ro/" },
            {
                title: "Muzică",
                img: "img/muzica.jpeg",
                link: "https://manuale.edu.ro/manuale/Clasa%20a%20VII-a/Educatie%20muzicala/QVJUIEtMRVRU/",
            },
            {
                title: "Religie",
                img: "img/religie.jpg",
                link: "https://manuale.edu.ro/manuale/Clasa%20a%20VII-a/Religie%20Cultul%20Ortodox/QWthZGVtb3MgQXJ0/",
            },
            {
                title: "Română",
                img: "img/romana.jpg",
                link: "https://manuale.edu.ro/manuale/Clasa%20a%20VII-a/Limba%20si%20literatura%20romana/QVJUIEtMRVRU/A1729.pdf",
            },
            {
                title: "Tehnologică",
                img: "img/tehno.png",
                link: "https://manuale.edu.ro/manuale/Clasa%20a%20VII-a/Educatie%20tehnologica%20si%20aplicatii%20practice/Q09SSU5UIExPR0lTVElD/",
            },
        ],
    },
    "7E": {
        timetable: [
            [
                "12:00",
                "",
                "Mate 📐",
                "Engleză <img src='img/en.png' alt='EN' class='text-img' />",
                "",
                "Mate 📐",
            ],
            [
                "13:00",
                "Engleză <img src='img/en.png' alt='EN' class='text-img' />",
                "Sport ⚽",
                "Religie ☦️",
                "Chimie 🧪",
                "Mate 📐",
            ],
            [
                "14:00",
                "Geografie 🌍",
                "Română <img src='img/ro.png' alt='RO' class='text-img' />",
                "Română <img src='img/ro.png' alt='RO' class='text-img' />",
                "Civică 🪪",
                "Latină 🦖",
            ],
            ["15:00", "Mate 📐", "Muzică 🎹", "Opț Mate 📐", "Biologie ⚕️", "Chimie 🧪"],
            [
                "16:00",
                "Română <img src='img/ro.png' alt='RO' class='text-img' />",
                "Fizică ☄️",
                "Dirigenție 📰",
                "Informatică 💻",
                "Română <img src='img/ro.png' alt='RO' class='text-img' />",
            ],
            [
                "17:00",
                "Franceză <img src='img/fr.png' alt='FR' class='text-img' />",
                "Tehnologică 🧰",
                "Franceză <img src='img/fr.png' alt='FR' class='text-img' />",
                "Fizică ☄️",
                "Sport ⚽",
            ],
            ["18:00", "Arte Plastice 🎨", "", "Biologie ⚕️", "Istorie 📜", ""],
        ],
        manuals: [
            {
                title: "Biologie",
                img: "img/manual-bio-new.png",
                link: "https://manuale.edu.ro/manuale/Clasa%20a%20VII-a/Biologie/Q09SSU5UIExPR0lTVElD/",
            },
            {
                title: "Chimie",
                img: "img/manual-chimie.jpg",
                link: "https://manuale.edu.ro/manuale/Clasa%20a%20VII-a/Chimie/QVJUIEtMRVRU/#book/00",
            },
            {
                title: "Civică",
                img: "img/manual-civica.png",
                link: "https://manuale.edu.ro/manuale/Clasa%20a%20VII-a/Educatie%20sociala/RURJVFVSQSBTSUdNQQ/#/page/c1",
            },
            {
                title: "Engleză",
                img: "img/manual-engleza.jpg",
                link: "https://catalog.manualedigitaleart.ro/art-engleza-lm1-7-2024/v1/index.html#book/00",
            },
            {
                title: "Fizică",
                img: "img/manual-fizica.jpg",
                link: "https://manuale.edu.ro/manuale/Clasa%20a%20VII-a/Fizica/QVJUIEtMRVRU/#book/00",
            },
            {
                title: "Franceză",
                img: "img/manual-franceza.png",
                link: "https://m.bookl.et/content/fra-vii/index.html#p=-1",
            },
            {
                title: "Geografie",
                img: "img/manual-geo.jpg",
                link: "https://manuale.edu.ro/manuale/Clasa%20a%20VII-a/Geografie/Q0QgUHJlc3M/index.html",
            },
            {
                title: "Informatică",
                img: "img/manual-info.png",
                link: "https://manuale.edu.ro/manuale/Clasa%20a%20VII-a/Informatica%20si%20TIC/R1JVUCBFRElUT1JJQUwg/",
            },
            {
                title: "Istorie",
                img: "img/manual-istorie.jpg",
                link: "https://manuale.edu.ro/manuale/Clasa%20a%20VII-a/Istorie/QWthZGVtb3MgQXJ0/",
            },
            {
                title: "Latină",
                img: "img/manual-latina.jpg",
                link: "https://manuale.edu.ro/manuale/Clasa%20a%20VII-a/Elemente%20de%20limba%20latina%20si%20de%20cultura%20romanica%20/QVJUIEtMRVRU/#book/00",
            },
            {
                title: "Matematică",
                img: "img/manual-matematica.png",
                link: "https://manuale.edu.ro/manuale/Clasa%20a%20VII-a/Matematica/Q09SSU5UIExPR0lTVElD/",
            },
            {
                title: "Muzică",
                img: "img/muzica.jpeg",
                link: "https://manuale.edu.ro/manuale/Clasa%20a%20VII-a/Educatie%20muzicala/QVJUIEtMRVRU/",
            },
            {
                title: "Religie",
                img: "img/religie.jpg",
                link: "https://manuale.edu.ro/manuale/Clasa%20a%20VII-a/Religie%20Cultul%20Ortodox/QWthZGVtb3MgQXJ0/",
            },
            {
                title: "Română",
                img: "img/romana.jpg",
                link: "https://manuale.edu.ro/manuale/Clasa%20a%20VII-a/Limba%20si%20literatura%20romana/QVJUIEtMRVRU/#book/00",
            },
            {
                title: "Tehnologică",
                img: "img/tehno.png",
                link: "https://manuale.edu.ro/manuale/Clasa%20a%20VII-a/Educatie%20tehnologica%20si%20aplicatii%20practice/Q09SSU5UIExPR0lTVElD/",
            },
        ],
    },
};

// --- RENDER TIMETABLE AND MANUALS ---
function renderTimetable(classKey) {
    const timetable = classData[classKey].timetable;
    const table = document.getElementById("timetable");
    // Determine hours for highlighting
    const hourIds = timetable.map((row) => row[0].split(":")[0]);
    table.innerHTML = `
        <thead>
            <tr>
                <td></td>
                <th id="Monday">Luni</th>
                <th id="Tuesday">Marți</th>
                <th id="Wednesday">Miercuri</th>
                <th id="Thursday">Joi</th>
                <th id="Friday">Vineri</th>
            </tr>
        </thead>
        <tbody>
            ${timetable
                .map(
                    (row, i) => `
                <tr>
                    <th id="${row[0].split(":")[0]}">${row[0]}</th>
                    ${row
                        .slice(1)
                        .map(
                            (cell, j) =>
                                `<td class="subject" id="d${j + 1}h${row[0].split(":")[0]}">${
                                    cell || ""
                                }</td>`
                        )
                        .join("")}
                </tr>
            `
                )
                .join("")}
        </tbody>
    `;
    // Save for highlight logic
    window._currentHourIds = hourIds;
}
function renderManuals(classKey) {
    const manuals = classData[classKey].manuals;
    const container = document.getElementById("manuals");
    container.innerHTML = manuals
        .map(
            (manual) => `
        <div class="container">
            <h2>${manual.title}</h2>
            <a href="${manual.link}" target="_blank">
                <img src="${manual.img}" alt="Manual ${manual.title}" />
            </a>
        </div>
    `
        )
        .join("");
}
function updateClass() {
    const classKey = document.getElementById("classSelector").value;
    localStorage.setItem("lastSelectedClass", classKey); // Save to localStorage
    // document.getElementById("classTitle").textContent = `Orar ${classKey}`;
    renderTimetable(classKey);
    renderManuals(classKey);
    setTimeout(setupSubjectHighlight, 100); // Wait for DOM
}
document.getElementById("classSelector").addEventListener("change", updateClass);

// --- HIGHLIGHT LOGIC ---
function highlightCurrent() {
    // Get current day/hour
    const date = new Date();
    let dayOfWeek = date.getDay(); // 0=Sun, 1=Mon, ..., 6=Sat
    if (dayOfWeek === 0) dayOfWeek = 7; // Sunday -> 7
    const currentHour = date.getHours();
    // Remove previous highlights
    ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"].forEach((id) => {
        const el = document.getElementById(id);
        if (el) el.classList.remove("current-day");
    });
    (window._currentHourIds || []).forEach((h) => {
        const el = document.getElementById(h);
        if (el) el.classList.remove("current-hour");
    });
    document
        .querySelectorAll("td.subject")
        .forEach((cell) => cell.classList.remove("current-cell"));
    // Highlight day
    if (dayOfWeek >= 1 && dayOfWeek <= 5) {
        const days = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"];
        const dayEl = document.getElementById(days[dayOfWeek - 1]);
        if (dayEl) dayEl.classList.add("current-day");
        // Highlight hour
        if ((window._currentHourIds || []).includes(currentHour.toString())) {
            const hourEl = document.getElementById(currentHour.toString());
            if (hourEl) hourEl.classList.add("current-hour");
            // Highlight cell
            const cellId = `d${dayOfWeek}h${currentHour}`;
            const cell = document.getElementById(cellId);
            if (cell) cell.classList.add("current-cell");
        }
    }
    // Update time display
    const hourOfTheDay = document.getElementById("hourOfTheDay");
    if (hourOfTheDay) {
        const mins = date.getMinutes().toString().padStart(2, "0");
        hourOfTheDay.textContent = `${date.getHours()}:${mins}`;

        // --- Add date display below time ---
        let dateDisplay = document.getElementById("dateOfTheDay");
        if (!dateDisplay) {
            dateDisplay = document.createElement("div");
            dateDisplay.id = "dateOfTheDay";
            hourOfTheDay.after(dateDisplay);
        }
        const day = date.getDate().toString().padStart(2, "0");
        const month = (date.getMonth() + 1).toString().padStart(2, "0");
        const year = date.getFullYear();
        dateDisplay.textContent = `${day}.${month}.${year}`;
    }
}
function setupSubjectHighlight() {
    document.querySelectorAll("td.subject").forEach((subject) => {
        subject.onclick = () => {
            const isMarked = subject.getAttribute("data-marked") === "true";
            if (!isMarked) {
                subject.innerHTML = "<mark>" + subject.innerHTML + "</mark>";
                subject.setAttribute("data-marked", "true");
            } else {
                subject.innerHTML = subject.innerHTML.replace("<mark>", "").replace("</mark>", "");
                subject.setAttribute("data-marked", "false");
            }
        };
    });
}
function startHighlightLoop() {
    highlightCurrent();
    setInterval(highlightCurrent, 2000);
}
startHighlightLoop();

// --- THEME & COLOR PICKER ---
const themeToggle = document.getElementById("switchTheme");
const themeIcon = document.getElementById("themeIcon");
let isDarkTheme = false;

function changeTheme() {
    isDarkTheme = !isDarkTheme;
    if (isDarkTheme) {
        document.body.setAttribute("data-theme", "dark");
        themeIcon.classList.remove("fa-sun");
        themeIcon.classList.add("fa-moon");
        localStorage.setItem("theme", "dark");
    } else {
        document.body.removeAttribute("data-theme");
        themeIcon.classList.remove("fa-moon");
        themeIcon.classList.add("fa-sun");
        localStorage.setItem("theme", "light");
    }
}

// Make sure the button triggers the function
themeToggle.addEventListener("click", changeTheme);

// On page load, apply saved theme
const savedTheme = localStorage.getItem("theme");
if (savedTheme === "dark") {
    document.body.setAttribute("data-theme", "dark");
    themeIcon.classList.remove("fa-sun");
    themeIcon.classList.add("fa-moon");
    isDarkTheme = true;
} else {
    document.body.removeAttribute("data-theme");
    themeIcon.classList.remove("fa-moon");
    themeIcon.classList.add("fa-sun");
    isDarkTheme = false;
}

const colorPicker = document.getElementById("accentColorPicker");
colorPicker.addEventListener("input", (event) => {
    const newColor = event.target.value;
    document.documentElement.style.setProperty("--accent-color", newColor);
});
colorPicker.addEventListener("change", (event) => {
    const newColor = event.target.value;
    localStorage.setItem("accentColor", newColor);
});
const savedColor = localStorage.getItem("accentColor");
if (savedColor) {
    document.documentElement.style.setProperty("--accent-color", savedColor);
    colorPicker.value = savedColor;
}

// --- WEATHER ---
function getWeather() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(fetchWeatherData, handleLocationError);
    } else {
        document.getElementById("weather-desc").textContent = "Geolocație indisponibilă.";
    }
}
function fetchWeatherData(position) {
    const lat = position.coords.latitude;
    const lon = position.coords.longitude;
    const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&daily=sunrise,sunset&timezone=auto`;
    fetch(url)
        .then((res) => res.json())
        .then((data) => {
            const weather = data.current_weather;
            const temp = `${weather.temperature}°C`;
            const sunrise = formatTime(data.daily.sunrise[0]);
            const sunset = formatTime(data.daily.sunset[0]);
            const now = new Date();
            const sunriseTime = new Date(data.daily.sunrise[0]);
            const sunsetTime = new Date(data.daily.sunset[0]);
            const isNight = now < sunriseTime || now > sunsetTime;
            const emoji = isNight ? "🌙" : getWeatherEmoji(weather.weathercode);
            document.getElementById("weather-emoji").textContent = emoji;
            document.getElementById("weather-temp").textContent = temp;
            document.getElementById("weather-desc").textContent = getWeatherDescription(
                weather.weathercode
            );
            document.getElementById("sunrise").textContent = sunrise;
            document.getElementById("sunset").textContent = sunset;
            fetchLocationName(lat, lon);
        })
        .catch(() => {
            document.getElementById("weather-desc").textContent = "Failed to fetch weather data.";
        });
}
function fetchLocationName(lat, lon) {
    fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`)
        .then((res) => res.json())
        .then((data) => {
            let location = "Locație necunoscută";
            if (data.address) {
                if (data.address.city) location = data.address.city;
                else if (data.address.town) location = data.address.town;
                else if (data.address.village) location = data.address.village;
                else if (data.address.county) location = data.address.county;
                if (data.address.country_code)
                    location += ", " + data.address.country_code.toUpperCase();
            }
            document.getElementById(
                "weather-location"
            ).innerHTML = `<i id="location-dot" class="fa-solid fa-location-dot"></i> ${location}`;
        })
        .catch(() => {
            document.getElementById(
                "weather-location"
            ).innerHTML = `<i id="location-dot" class="fa-solid fa-location-dot"></i> Locație necunoscută`;
        });
}
function handleLocationError() {
    document.getElementById("weather-desc").textContent = "Nu s-a putut obține locația.";
}
function formatTime(iso) {
    const d = new Date(iso);
    return (
        d.getHours().toString().padStart(2, "0") + ":" + d.getMinutes().toString().padStart(2, "0")
    );
}
function getWeatherEmoji(code) {
    if (code === 0) return "☀️";
    if ([1, 2].includes(code)) return "🌤️";
    if (code === 3) return "☁️";
    if ([45, 48].includes(code)) return "🌫️";
    if ([51, 53, 55, 56, 57].includes(code)) return "🌦️";
    if ([61, 63, 65, 66, 67, 80, 81, 82].includes(code)) return "🌧️";
    if ([71, 73, 75, 77, 85, 86].includes(code)) return "❄️";
    if ([95, 96, 99].includes(code)) return "⛈️";
    return "❓";
}
function getWeatherDescription(code) {
    if (code === 0) return "Senin";
    if ([1, 2].includes(code)) return "Parțial noros";
    if (code === 3) return "Noros";
    if ([45, 48].includes(code)) return "Ceață";
    if ([51, 53, 55, 56, 57].includes(code)) return "Burniță";
    if ([61, 63, 65, 66, 67, 80, 81, 82].includes(code)) return "Ploaie";
    if ([71, 73, 75, 77, 85, 86].includes(code)) return "Ninsoare";
    if ([95, 96, 99].includes(code)) return "Furtună";
    return "Necunoscut";
}
getWeather();
setInterval(getWeather, 300000);

// --- TO-DO LIST WITH DRAG & DROP AND EDIT ---
document.addEventListener("DOMContentLoaded", () => {
    const taskList = document.querySelector(".todo-list");
    const addTaskInput = document.querySelector(".add-task input[type='text']");
    const addTaskButton = document.querySelector(".add-task button");
    const TODO_KEY = "todo-tasks";

    function addTask(text, checked = false) {
        const li = document.createElement("li");
        li.className = "todo-item";
        li.draggable = true;
        li.innerHTML = `
            <input type="checkbox" ${checked ? "checked" : ""}>
            <label>${text}</label>
            <button class="delete-btn" title="Șterge"><i class="fa fa-trash" aria-hidden="true"></i></button>
        `;
        taskList.appendChild(li);
        saveTasks();
    }

    function saveTasks() {
        const tasks = [];
        document.querySelectorAll(".todo-item").forEach((item) => {
            const label = item.querySelector("label").textContent;
            const checked = item.querySelector('input[type="checkbox"]').checked;
            tasks.push({ text: label, checked });
        });
        localStorage.setItem(TODO_KEY, JSON.stringify(tasks));
    }

    function loadTasks() {
        taskList.innerHTML = "";
        const data = JSON.parse(localStorage.getItem(TODO_KEY)) || [];
        data.forEach((task) => addTask(task.text, task.checked));
    }

    // Add task on button click
    addTaskButton.addEventListener("click", () => {
        const taskText = addTaskInput.value.trim();
        if (taskText) {
            addTask(taskText);
            addTaskInput.value = "";
        }
    });

    // Add task on Enter key
    addTaskInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
            addTaskButton.click();
        }
    });

    // Task actions: delete, checkbox, edit (dblclick)
    taskList.addEventListener("click", (e) => {
        const target = e.target;
        // Delete
        if (target.classList.contains("delete-btn") || target.closest(".delete-btn")) {
            const li = target.closest("li");
            if (li) {
                li.remove();
                saveTasks();
            }
            return;
        }
        // Checkbox
        if (target.type === "checkbox") {
            saveTasks();
        }
    });

    // Double click to edit
    taskList.addEventListener("dblclick", (e) => {
        const label = e.target.closest("label");
        if (!label) return;
        const li = label.closest("li");
        const oldText = label.textContent;
        const input = document.createElement("input");
        input.type = "text";
        input.value = oldText;
        input.className = "edit-task-input";
        label.replaceWith(input);
        input.focus();

        function saveEdit() {
            const newText = input.value.trim() || oldText;
            const newLabel = document.createElement("label");
            newLabel.textContent = newText;
            input.replaceWith(newLabel);
            saveTasks();
        }
        input.addEventListener("blur", saveEdit);
        input.addEventListener("keypress", (event) => {
            if (event.key === "Enter") {
                input.blur();
            }
        });
    });

    // Drag and drop functionality
    let draggedItem = null;

    taskList.addEventListener("dragstart", (e) => {
        if (e.target.classList.contains("todo-item")) {
            draggedItem = e.target;
            e.target.classList.add("dragging");
        }
    });

    taskList.addEventListener("dragend", (e) => {
        if (e.target.classList.contains("todo-item")) {
            e.target.classList.remove("dragging");
            draggedItem = null;
            saveTasks();
        }
    });

    taskList.addEventListener("dragover", (e) => {
        e.preventDefault();
        const afterElement = getDragAfterElement(taskList, e.clientY);
        if (!draggedItem) return;
        if (afterElement == null) {
            taskList.appendChild(draggedItem);
        } else {
            taskList.insertBefore(draggedItem, afterElement);
        }
    });

    function getDragAfterElement(container, y) {
        const draggableElements = [...container.querySelectorAll(".todo-item:not(.dragging)")];
        return draggableElements.reduce(
            (closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            },
            { offset: -Infinity }
        ).element;
    }

    loadTasks();
});

// --- SETTINGS MENU LOGIC ---

const settingsButton = document.getElementById("settingsButton");
const settingsMenu = document.getElementById("settingsMenu");
const settingsIcon = settingsButton.querySelector("i");

function rotateSettingsIcon(direction) {
    settingsIcon.classList.remove("rotate-once-right", "rotate-once-left");
    void settingsIcon.offsetWidth; // Force reflow to restart animation
    if (direction === "right") {
        settingsIcon.classList.add("rotate-once-right");
    } else {
        settingsIcon.classList.add("rotate-once-left");
    }
}

settingsButton.addEventListener("click", (e) => {
    e.stopPropagation();
    const isOpening = !settingsMenu.classList.contains("open");
    settingsMenu.classList.toggle("open");
    rotateSettingsIcon(isOpening ? "right" : "left");
});

document.addEventListener("click", (e) => {
    if (!settingsMenu.contains(e.target) && !settingsButton.contains(e.target)) {
        if (settingsMenu.classList.contains("open")) {
            settingsMenu.classList.remove("open");
            rotateSettingsIcon("left");
        }
    }
});

// --- INITIAL RENDER ---
const lastClass = localStorage.getItem("lastSelectedClass");
if (lastClass && document.getElementById("classSelector")) {
    document.getElementById("classSelector").value = lastClass;
}
updateClass();

// Fancy horizontal scroll indicator
const scrollIndicator = document.getElementById("scroll-indicator");
window.addEventListener("scroll", () => {
    const scrollable = document.documentElement.scrollHeight - window.innerHeight;
    const scrolled = window.scrollY;
    const percent = scrollable > 0 ? (scrolled / scrollable) * 100 : 0;
    scrollIndicator.style.width = percent + "%";
});

// Favicon

function updateFavicon(accentColor) {
    const size = 16;
    const canvas = document.createElement("canvas");
    canvas.width = canvas.height = size;
    const ctx = canvas.getContext("2d");
    // Draw circle with accent color
    ctx.beginPath();
    ctx.arc(size / 2, size / 2, size / 2, 0, 2 * Math.PI);
    ctx.fillStyle = accentColor;
    ctx.fill();
    // Set as favicon
    const link = document.querySelector("link[rel~='icon']") || document.createElement("link");
    link.rel = "icon";
    link.type = "image/png";
    link.href = canvas.toDataURL("image/png");
    document.head.appendChild(link);
}

// Initial set
updateFavicon(getComputedStyle(document.documentElement).getPropertyValue("--accent-color").trim());

// Update when accent color changes
const accentColorPicker = document.getElementById("accentColorPicker");
if (accentColorPicker) {
    accentColorPicker.addEventListener("input", (e) => {
        updateFavicon(e.target.value);
    });
}
